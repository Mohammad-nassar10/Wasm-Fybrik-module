{{- if .Values.read -}}
transformations:
  - name: "filter_minors"
    wasm_image: "ghcr.io/the-mesh-for-data/alloc-transform:v1"
    configuration:  |
      {
        "columns": ["name", "age", "address"]
      }
  - name: "Redact"
    wasm_image: "ghcr.io/the-mesh-for-data/alloc-transform:v1"
    configuration:  |
      {
        "columns": ["name", "age", "address"]
      }
data:
{{- range .Values.read }}
  - format: {{ .source.format }}
    name: {{ .assetID | quote }}
    {{- if (contains "fake" .assetID | quote) }}
    path: "{{ .source.connection.s3.endpoint }}"
    connection:
      type: localfs
    {{- end }}
    {{- if .transformations }}
    transformations:
    {{- $redactColumns := list -}}
    {{- $removeColumns := list -}}
    {{- range .transformations -}}
      {{- if eq .id "redact-ID" -}}
        {{- $redactColumns = append  $redactColumns .args.column_name -}}
      {{- end -}}
      {{- if eq .id "removed-ID" -}}
        {{- $removeColumns = append  $removeColumns .args.column_name -}}
      {{- end -}}
    {{- end -}}
    {{- if $redactColumns }}
      - action: "Redact"
        description: "redacting columns: {{ $redactColumns }}"
        columns: 
          {{- range $redactColumns}}
          - {{ . }}
          {{- end }}
        options:
          redactValue: "XXXXX"
    {{- end }}
    {{- if $removeColumns }}
      - action: "RemoveColumns"
        description: "removing columns: {{ $removeColumns }}"
        columns: 
          {{- range $removeColumns}}
          - {{ . }}
          {{- end }}
    {{- end }}
    {{- end }}
{{- end -}}
{{- else -}}
data: []
{{- end -}}